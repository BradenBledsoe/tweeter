AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM config for Tweeter server

#
# Global Lambda function properties. These apply to every Lambda function.
#
Globals:
    Function:
        Runtime: nodejs20.x
        CodeUri: ./dist/
        Layers:
            - !Ref tweeterLayer
        Timeout: 30
        MemorySize: 128

#
# Reusable blocks of configuration. These are referenced throughout the template to avoid duplication.
# &identifier is used to define a reusable block, and *identifier is used to reference it.
#
Metadata:
    x-common-policies: &commonPolicies
        - AWSLambdaBasicExecutionRole
        - AmazonSESFullAccess
        - CloudWatchFullAccess
        - AmazonDynamoDBFullAccess
        - AmazonS3FullAccess
        - AmazonSQSFullAccess

    x-common-cors-headers: &commonCorsHeaders
        method.response.header.Access-Control-Allow-Origin: "'*'"

    x-common-swagger-response-headers: &commonSwaggerResponseHeaders
        Access-Control-Allow-Origin:
            type: string

#
# AWS resource definitions
#
Resources:
    #
    # Web API
    #

    tweeterApi:
        Type: AWS::Serverless::Api
        Properties:
            Name: tweeterApi
            StageName: prod
            Cors:
                AllowMethods: "'GET,POST,PUT,DELETE'"
                AllowHeaders: "'*'"
                AllowOrigin: "'*'"
            DefinitionBody:
                swagger: "2.0"
                info:
                    title: "Tweeter API"
                    version: "1.0"
                x-common-consumes: &commonConsumes
                    - application/json
                x-common-produces: &commonProduces
                    - application/json
                x-common-request-templates: &commonRequestTemplates
                    application/json: $input.json('$')
                x-common-amazon-responses: &commonAmazonResponses
                    default:
                        statusCode: 200
                        responseParameters: *commonCorsHeaders
                    ".*bad-request.*":
                        statusCode: 400
                        responseParameters: *commonCorsHeaders
                        responseTemplates:
                            application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
                    ".*unauthorized.*":
                        statusCode: 401
                        responseParameters: *commonCorsHeaders
                        responseTemplates:
                            application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
                    ".*internal-server-error.*":
                        statusCode: 500
                        responseParameters: *commonCorsHeaders
                        responseTemplates:
                            application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
                x-common-swagger-responses: &commonSwaggerResponses
                    "200":
                        description: "OK"
                        headers: *commonSwaggerResponseHeaders
                    "400":
                        description: "Bad Request"
                        headers: *commonSwaggerResponseHeaders
                    "401":
                        description: "Unauthorized"
                        headers: *commonSwaggerResponseHeaders
                    "500":
                        description: "Internal Server Error"
                        headers: *commonSwaggerResponseHeaders
                paths:
                    #
                    # Endpoint definitions
                    #

                    /followees/get:
                        post:
                            summary: "Get Followees"
                            description: "Retrieves a paginated list of users that the specified user is following"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweesFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /followers/get:
                        post:
                            summary: "Get Followers"
                            description: "Retrieves a paginated list of users that are following the specified user"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowersFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /follow/status:
                        post:
                            summary: "Get Follow Status"
                            description: "Determines if one user is currently following another user"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getIsFollowerStatusFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /follow:
                        post:
                            summary: "Follow User"
                            description: "Creates a follow relationship between the authenticated user and the specified user"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${followFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /unfollow:
                        post:
                            summary: "Unfollow User"
                            description: "Removes a follow relationship between the authenticated user and the specified user"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${unfollowFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /followees/count:
                        post:
                            summary: "Get Followee Count"
                            description: "Returns the total number of users that the specified user is following"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweeCountFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /followers/count:
                        post:
                            summary: "Get Follower Count"
                            description: "Returns the total number of users that are following the specified user"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowerCountFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /login:
                        post:
                            summary: "User Login"
                            description: "Authenticates a user with alias and password, returns user info and auth token"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loginFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /user:
                        post:
                            summary: "Get User"
                            description: "Retrieves user information by alias"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getUserFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /register:
                        post:
                            summary: "User Registration"
                            description: "Creates a new user account with profile information and image, returns user info and authtoken"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${registerFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /logout:
                        post:
                            summary: "User Logout"
                            description: "Invalidates the user's authtoken and logs them out"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${logoutFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /feeditems/get:
                        post:
                            summary: "Get Feed Items"
                            description: "Retrieves a paginated list of status posts from users that the authenticated user follows"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loadMoreFeedItemsFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /storyitems/get:
                        post:
                            summary: "Get Story Items"
                            description: "Retrieves a paginated list of status posts created by the authenticated user"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loadMoreStoryItemsFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                    /status/post:
                        post:
                            summary: "Post Status"
                            description: "Creates a new status post for the authenticated user"
                            consumes: *commonConsumes
                            produces: *commonProduces
                            x-amazon-apigateway-integration:
                                type: aws
                                httpMethod: POST
                                uri:
                                    Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${postStatusFunction.Arn}/invocations
                                requestTemplates: *commonRequestTemplates
                                responses: *commonAmazonResponses
                            responses: *commonSwaggerResponses

                        #
                        # TODO: ADD MORE ENDPOINT DEFINITIONS HERE
                        #

    #
    # SQS Queues  (This will become relevant in Milestone 4. For M3, leave this section commented out.)
    #

    #   MyQueue:
    #     Type: AWS::SQS::Queue
    #     Properties:
    #       QueueName: MyQueue

    # SQS queues for async feed processing
    PostUpdateQueue:
        Type: AWS::SQS::Queue
        Properties:
            QueueName: post-update-feed-queue
            VisibilityTimeout: 40

    UpdateFeedQueue:
        Type: AWS::SQS::Queue
        Properties:
            QueueName: update-feed-queue
            VisibilityTimeout: 10

    #
    # Lambda Layer (reused by all Lambda functions)
    #
    tweeterLayer:
        Type: AWS::Serverless::LayerVersion
        Properties:
            LayerName: tweeterLayer
            Description: dependencies layer for Tweeter server
            ContentUri: ./layer/
            CompatibleRuntimes:
                - nodejs20.x
            RetentionPolicy: DELETE

    #
    # Web API Lambda functions
    #

    #
    # SQS Queue Lambda Functions  (This will become relevant in Milestone 4. For M3, leave this section commented out.)
    #

    #   MyQueueFunction:
    #     Type: AWS::Serverless::Function
    #     Properties:
    #       FunctionName: MyQueueFunction
    #       Handler: <PATH TO LAMBDA HANDLER>
    #       Policies: *commonPolicies
    #       Events:
    #         SQSTrigger:
    #           Type: SQS
    #           Properties:
    #             Queue: !GetAtt MyQueue.Arn
    #             Enabled: true

    getFolloweesFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterGetFollowees
            Handler: /follow/GetFolloweesLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /followees/get
                        Method: POST

    getFollowersFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterGetFollowers
            Handler: /follow/GetFollowersLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /followers/get
                        Method: POST

    getIsFollowerStatusFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterGetIsFollowerStatus
            Handler: /follow/GetIsFollowerLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /follow/status
                        Method: POST

    followFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterFollow
            Handler: /follow/FollowLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /follow
                        Method: POST

    unfollowFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterUnfollow
            Handler: /follow/UnfollowLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /unfollow
                        Method: POST

    getFolloweeCountFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterGetFolloweeCount
            Handler: /follow/GetFolloweesCountLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /followees/count
                        Method: POST

    getFollowerCountFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterGetFollowerCount
            Handler: /follow/GetFollowersCountLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /followers/count
                        Method: POST

    loginFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterLogin
            Handler: /user/LoginLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /login
                        Method: POST

    getUserFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterGetUser
            Handler: /user/GetUserLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /user
                        Method: POST

    registerFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterRegister
            Handler: /user/RegisterLambda.handler
            Policies: *commonPolicies
            Environment:
                Variables:
                    TWEETER_IMAGES_BUCKET: !Ref tweeterImagesBucket
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /register
                        Method: POST

    logoutFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterLogout
            Handler: /user/LogoutLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /logout
                        Method: POST

    getFeedItemsFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterLoadMoreFeedItems
            Handler: /status/GetFeedItemsLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /feeditems/get
                        Method: POST

    getStoryItemsFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterLoadMoreStoryItems
            Handler: /status/GetStoryItemsLambda.handler
            Policies: *commonPolicies
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /storyitems/get
                        Method: POST

    postStatusFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterPostStatus
            Handler: /status/PostStatusLambda.handler
            Policies: *commonPolicies
            Environment:
                Variables:
                    POST_UPDATE_FEED_QUEUE_URL: !Ref PostUpdateQueue
            Events:
                PostApi:
                    Type: Api
                    Properties:
                        RestApiId: !Ref tweeterApi
                        Path: /status/post
                        Method: POST

    # Lambda triggered by PostUpdateQueue: reads status message, fetches followers and enqueues chunks to UpdateFeedQueue
    postUpdateFeedMessagesFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterPostUpdateFeedMessages
            Handler: /status/PostUpdateFeedMessagesLambda.handler
            Policies: *commonPolicies
            Environment:
                Variables:
                    UPDATE_FEED_QUEUE_URL: !Ref UpdateFeedQueue
            Timeout: 30
            Events:
                SQSTrigger:
                    Type: SQS
                    Properties:
                        Queue: !GetAtt PostUpdateQueue.Arn
                        Enabled: true

    # Lambda triggered by UpdateFeedQueue: writes batches to feed table
    updateFeedsFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: tweeterUpdateFeeds
            Handler: /status/UpdateFeedsLambda.handler
            Policies: *commonPolicies
            Timeout: 5
            Events:
                SQSTrigger:
                    Type: SQS
                    Properties:
                        Queue: !GetAtt UpdateFeedQueue.Arn
                        Enabled: true

    #
    # DynamoDB Tables
    #

    # Follow relationships table
    followsTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: tweeterFollows
            AttributeDefinitions:
                - AttributeName: follower_alias
                  AttributeType: S
                - AttributeName: followee_alias
                  AttributeType: S
            KeySchema:
                - AttributeName: follower_alias
                  KeyType: HASH
                - AttributeName: followee_alias
                  KeyType: RANGE
            BillingMode: PROVISIONED
            ProvisionedThroughput:
                ReadCapacityUnits: 5
                WriteCapacityUnits: 5
            GlobalSecondaryIndexes:
                - IndexName: followee-follower-index
                  KeySchema:
                      - AttributeName: followee_alias
                        KeyType: HASH
                      - AttributeName: follower_alias
                        KeyType: RANGE
                  ProvisionedThroughput:
                      ReadCapacityUnits: 5
                      WriteCapacityUnits: 5
                  Projection:
                      ProjectionType: ALL

    # Users table
    usersTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: tweeterUsers
            AttributeDefinitions:
                - AttributeName: alias
                  AttributeType: S
            KeySchema:
                - AttributeName: alias
                  KeyType: HASH
            BillingMode: PROVISIONED
            ProvisionedThroughput:
                ReadCapacityUnits: 5
                WriteCapacityUnits: 5

    # Status posts table
    statusesTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: tweeterStatuses
            AttributeDefinitions:
                - AttributeName: author_alias
                  AttributeType: S
                - AttributeName: timestamp
                  AttributeType: N
            KeySchema:
                - AttributeName: author_alias
                  KeyType: HASH
                - AttributeName: timestamp
                  KeyType: RANGE
            BillingMode: PROVISIONED
            ProvisionedThroughput:
                ReadCapacityUnits: 5
                WriteCapacityUnits: 5

    # User feeds table (pre-computed feeds)
    feedTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: tweeterFeed
            AttributeDefinitions:
                - AttributeName: feed_owner_alias
                  AttributeType: S
                - AttributeName: timestamp
                  AttributeType: N
            KeySchema:
                - AttributeName: feed_owner_alias
                  KeyType: HASH
                - AttributeName: timestamp
                  KeyType: RANGE
            BillingMode: PROVISIONED
            ProvisionedThroughput:
                ReadCapacityUnits: 10
                WriteCapacityUnits: 100

    # Authentication tokens table
    authTokensTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: tweeterAuthtokens
            AttributeDefinitions:
                - AttributeName: token
                  AttributeType: S
            KeySchema:
                - AttributeName: token
                  KeyType: HASH
            BillingMode: PROVISIONED
            ProvisionedThroughput:
                ReadCapacityUnits: 5
                WriteCapacityUnits: 5
            TimeToLiveSpecification:
                AttributeName: timestamp
                Enabled: true

    # S3 Bucket for user profile images
    tweeterImagesBucket:
        Type: AWS::S3::Bucket
        Properties:
            BucketName: !Sub "tweeter-images-${AWS::AccountId}-${AWS::Region}"
            PublicAccessBlockConfiguration:
                BlockPublicAcls: false
                BlockPublicPolicy: false
                IgnorePublicAcls: false
                RestrictPublicBuckets: false
            CorsConfiguration:
                CorsRules:
                    - AllowedHeaders:
                          - "*"
                      AllowedMethods:
                          - GET
                          - PUT
                          - POST
                          - DELETE
                          - HEAD
                      AllowedOrigins:
                          - "*"
                      MaxAge: 3000
